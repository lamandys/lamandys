---
title: 手写一个权限申请库
date: 2020-01-20 18:32:55
tags: [Android]
---

网上的权限申请库那么多，你为什么要自己写一个？的确，网上开源库千千万，用起来也很方便。可是那都是人家的，你确定你自己不写一下？很简单，我想继续造轮子，不然我不懂怎么玩😁

<!-- more -->

<img src="../手写一个权限申请库/1.jpg" width = "800" height = "534" alt="与文无关" align=center />

#### 动手 要写肯定要写一个可以很简单的使用的库啦
1. 入口
a. 参数设计就是第一个上下文，至于为什么要用FragmentActivity，下面揭晓
b. 第二个是传递一个List过去，让接入方把需要的权限添加即可。
c. 最后一个就是callback，请求过程中的回调
```
public static void request(FragmentActivity activity, Consumer<ArrayList<String>> consumer, PermissionCallback callback) {
        PermissionDelegateFragment delegateFragment = PermissionDelegateFinder.getInstance().find(activity);
        ArrayList<String> perms = new ArrayList<>();
        consumer.accept(perms);
        delegateFragment.request(perms.toArray(new String[]{}), callback);
    }
```
2. 有了入口，就是进行请求权限了
 不急，上面提到的为什么要用FragmentActivity呢？看代码：
```
PermissionDelegateFragment delegateFragment = PermissionDelegateFinder.getInstance().find(activity);
```
	activity在这一行有用到，具体是什么呢？继续往下看看。
3. 寻找代理请求对象
```
 public PermissionDelegateFragment find(FragmentActivity fragmentActivity) {
        PermissionDelegateFragment permissionDelegateFragment = null;
        if (!fragmentActivity.isFinishing()) {
            permissionDelegateFragment = findByFragmentManager(fragmentActivity.getSupportFragmentManager());
        }
        return permissionDelegateFragment;
    }
```
	噢，原来activity的作用是关联代理请求对象的。
```
private PermissionDelegateFragment findByFragmentManager(final FragmentManager manager) {
        Fragment fragment = manager.findFragmentByTag(PERMISSION_TAG);
        if (fragment == null) {
            fragment = new PermissionDelegateFragment();
            manager.beginTransaction().add(fragment, PERMISSION_TAG).commitAllowingStateLoss();
        }
        return (PermissionDelegateFragment) fragment;
    }
```	
	如果该activity没有请求过权限，是不会有代理对象的。当第一次进行请求的时候，创建代理对象，并添加到activity中进行管理。突然明白了。
4. 找到代理对象，进行请求
```

```